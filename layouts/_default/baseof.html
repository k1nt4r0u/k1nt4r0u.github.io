<!DOCTYPE html>
<html lang="{{ .Site.Language }}">
<head>
    <title>{{ if not .IsHome }}{{ .Title }} | {{ end }}{{ .Site.Title }}</title>
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="shortcut icon" href="/favicon.ico">
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    {{ partial "style.html" . }}
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="index, follow">
    <meta charset="utf-8">
    <script src="/js/theme-switcher.js"></script>
    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\[', right: '\\]', display: true},
                    {left: '\\(', right: '\\)', display: false}
                ],
                throwOnError : false
            });
        });
    </script>
</head>
<body>
<!-- Scroll Progress Bar -->
<div id="scroll-progress-bar"></div>
{{ partial "navbar.html" . }}
<main>
    {{ block "main" . }}{{ end }}
</main>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const addCopyButtons = () => {
        document.querySelectorAll('.highlight').forEach((box) => {
            if (box.querySelector('.copy-code-button')) return;

            // Tạo button và chèn icon SVG (2 ô vuông đè lên nhau)
            const button = document.createElement('button');
            button.className = 'copy-code-button';
            button.type = 'button';
            button.innerHTML = `
                <svg class="icon-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                <svg class="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><polyline points="20 6 9 17 4 12"></polyline></svg>
            `;

            box.style.position = 'relative';
            box.appendChild(button);

            button.addEventListener('click', () => {
                const codeElement = box.querySelector('td:last-child pre code') || 
                                    box.querySelector('td:last-child pre') || 
                                    box.querySelector('code');
                
                const textToCopy = codeElement.innerText;

                navigator.clipboard.writeText(textToCopy).then(() => {
                    // Hiện icon Check, ẩn icon Copy
                    const iconCopy = button.querySelector('.icon-copy');
                    const iconCheck = button.querySelector('.icon-check');
                    
                    iconCopy.style.display = 'none';
                    iconCheck.style.display = 'block';
                    button.classList.add('copied');

                    setTimeout(() => {
                        iconCopy.style.display = 'block';
                        iconCheck.style.display = 'none';
                        button.classList.remove('copied');
                    }, 2000);
                });
            });
        });
    };

    addCopyButtons();
    setTimeout(addCopyButtons, 500);
});

// Scroll Progress Bar
window.addEventListener('scroll', () => {
    const scrollProgress = document.getElementById('scroll-progress-bar');
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrollPercent = (scrollTop / docHeight) * 100;
    scrollProgress.style.width = scrollPercent + '%';
});

// Image Lightbox
document.addEventListener('DOMContentLoaded', () => {
    // Create lightbox elements
    const lightbox = document.createElement('div');
    lightbox.id = 'image-lightbox';
    lightbox.innerHTML = `
        <span class="lightbox-close">&times;</span>
        <div class="lightbox-image-container">
            <img class="lightbox-content" id="lightbox-img">
        </div>
    `;
    document.body.appendChild(lightbox);

    let currentZoom = 1;
    let isDragging = false;
    let startX, startY, translateX = 0, translateY = 0;
    const lightboxImg = document.getElementById('lightbox-img');
    const imageContainer = lightbox.querySelector('.lightbox-image-container');

    const updateZoom = (scale) => {
        currentZoom = Math.max(0.5, Math.min(5, scale));
        lightboxImg.style.transition = 'transform 0.2s ease-out';
        lightboxImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
        lightboxImg.style.cursor = currentZoom > 1 ? 'grab' : 'default';
    };

    // Pan functionality
    lightboxImg.addEventListener('mousedown', (e) => {
        if (currentZoom > 1) {
            e.preventDefault();
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            lightboxImg.style.cursor = 'grabbing';
            lightboxImg.style.transition = 'none';
        }
    });

    document.addEventListener('mousemove', (e) => {
        if (isDragging) {
            e.preventDefault();
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            lightboxImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
        }
    });

    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            lightboxImg.style.cursor = currentZoom > 1 ? 'grab' : 'default';
            lightboxImg.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        }
    });

    // Touch support for mobile
    let touchStartX, touchStartY;
    lightboxImg.addEventListener('touchstart', (e) => {
        if (currentZoom > 1) {
            touchStartX = e.touches[0].clientX - translateX;
            touchStartY = e.touches[0].clientY - translateY;
            lightboxImg.style.transition = 'none';
        }
    });

    lightboxImg.addEventListener('touchmove', (e) => {
        if (currentZoom > 1) {
            e.preventDefault();
            translateX = e.touches[0].clientX - touchStartX;
            translateY = e.touches[0].clientY - touchStartY;
            lightboxImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
        }
    }, { passive: false });

    lightboxImg.addEventListener('touchend', () => {
        if (currentZoom > 1) {
            lightboxImg.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        }
    });

    // Mouse wheel zoom
    lightbox.addEventListener('wheel', (e) => {
        if (lightbox.style.display === 'flex') {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            updateZoom(currentZoom + delta);
        }
    }, { passive: false });

    // Add click event to all images in post-content
    const postImages = document.querySelectorAll('.post-content img');
    postImages.forEach(img => {
        img.style.cursor = 'pointer';
        img.addEventListener('click', () => {
            lightbox.style.display = 'flex';
            lightboxImg.src = img.src;
            currentZoom = 1;
            translateX = 0;
            translateY = 0;
            updateZoom(1);
            document.body.style.overflow = 'hidden';
        });
    });

    // Close lightbox
    const closeLightbox = () => {
        lightbox.style.display = 'none';
        document.body.style.overflow = 'auto';
        translateX = 0;
        translateY = 0;
        updateZoom(1);
    };

    lightbox.querySelector('.lightbox-close').addEventListener('click', closeLightbox);
    lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox || e.target === imageContainer) closeLightbox();
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && lightbox.style.display === 'flex') {
            closeLightbox();
        }
    });
});
</script>
<footer id="footer">
    <div class="footer-container">
        <p>© {{ now.Format "2006" }} {{ .Site.Title }}. All rights reserved.</p>
        <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://github.com/salatine/neopost" target="_blank">neopost</a></p>
    </div>
</footer>
</body>
</html>
